{% extends "dashboard.html" %}

{% block content %}
<!-- Procurement Overview Stats -->
<div class="grid grid-4">
    <div class="stats-card danger">
        <div class="stats-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">{{ analysis.summary.critical_items }}</div>
            <div class="stats-label">Critical Items</div>
        </div>
    </div>
    <div class="stats-card warning">
        <div class="stats-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">{{ analysis.summary.urgent_items }}</div>
            <div class="stats-label">Urgent Items</div>
        </div>
    </div>
    <div class="stats-card info">
        <div class="stats-icon">
            <i class="fas fa-building"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">{{ analysis.summary.companies_needing_procurement }}</div>
            <div class="stats-label">Companies Affected</div>
        </div>
    </div>
    <div class="stats-card success">
        <div class="stats-icon">
            <i class="fas fa-rupee-sign"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">₹{{ "{:,.0f}".format(analysis.summary.total_estimated_cost/1000) }}K</div>
            <div class="stats-label">Estimated Cost</div>
        </div>
    </div>
</div>

<!-- Procurement Action Items -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-tasks"></i>
            Procurement Action Items
        </h3>
        <div class="card-actions">
            <button class="btn btn-primary" onclick="runFullAnalysis()">
                <i class="fas fa-chart-line"></i>
                Run Analysis
            </button>
            <button class="btn btn-success" onclick="autoGenerateOrders()">
                <i class="fas fa-magic"></i>
                Auto Generate Orders
            </button>
            <button class="btn btn-light" onclick="app.refreshData()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="action-items-container">
            {% for company_id, company_analysis in analysis.companies.items() %}
            {% set company = companies[company_id] %}
            <div class="action-item-group">
                <div class="company-header">
                    <h4>{{ company.name }}</h4>
                    <div class="company-meta">
                        <span class="budget-info">Budget: ₹{{ "{:,.0f}".format(company.budget_monthly) }}/month</span>
                        <span class="priority-badge priority-{{ company.procurement_priority }}">
                            {{ company.procurement_priority.replace('_', ' ').title() }}
                        </span>
                    </div>
                </div>
                
                <div class="items-grid">
                    {% for item_analysis in company_analysis.items_needed %}
                    <div class="procurement-item priority-{{ item_analysis.urgency }}">
                        <div class="item-header">
                            <div class="item-name">{{ item_analysis.item.name }}</div>
                            <div class="urgency-badge urgency-{{ item_analysis.urgency }}">
                                {{ item_analysis.urgency.title() }}
                            </div>
                        </div>
                        
                        <div class="item-details">
                            <div class="stock-info">
                                <div class="stock-levels">
                                    <span class="current">Current: {{ item_analysis.item.current_stock }}</span>
                                    <span class="required">Required: {{ item_analysis.item.minimum_required }}</span>
                                    <span class="shortage">Shortage: {{ item_analysis.shortage }}</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-danger" 
                                         style="width: {{ (item_analysis.item.current_stock / item_analysis.item.minimum_required * 100) }}%">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="procurement-details">
                                <div class="recommended-order">
                                    <strong>Recommended Order: {{ item_analysis.recommended_order }} {{ item_analysis.item.unit }}</strong>
                                </div>
                                <div class="cost-estimate">
                                    Estimated Cost: ₹{{ "{:,.2f}".format(item_analysis.estimated_cost) }}
                                </div>
                                
                                {% if recommendations[company_id] and recommendations[company_id].get(item_analysis.item.item_id) %}
                                {% set rec = recommendations[company_id][item_analysis.item.item_id] %}
                                <div class="vendor-recommendation">
                                    <div class="recommended-vendor">
                                        <strong>Recommended:</strong> {{ rec.vendor.name }}
                                        <span class="vendor-rating">
                                            {% for i in range(5) %}
                                                {% if i < rec.vendor.rating %}⭐{% endif %}
                                            {% endfor %}
                                            {{ rec.vendor.rating }}/5
                                        </span>
                                    </div>
                                    <div class="vendor-details">
                                        <span>Response: {{ rec.vendor.response_time }}</span>
                                        <span>Price: {{ rec.vendor.price_competitiveness.replace('_', ' ').title() }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="item-actions">
                            <button class="btn btn-sm btn-primary" onclick="contactVendor('{{ item_analysis.item.item_id }}', '{{ company_id }}')">
                                <i class="fas fa-phone"></i>
                                Contact Vendor
                            </button>
                            <button class="btn btn-sm btn-success" onclick="generateQuote('{{ item_analysis.item.item_id }}', '{{ company_id }}')">
                                <i class="fas fa-file-invoice-dollar"></i>
                                Get Quote
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="markUrgent('{{ item_analysis.item.item_id }}', '{{ company_id }}')">
                                <i class="fas fa-exclamation"></i>
                                Mark Urgent
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Budget Analysis -->
<div class="grid grid-2">
    <!-- Budget Utilization -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie"></i>
                Budget Utilization
            </h3>
        </div>
        <div class="card-body">
            <div class="budget-analysis">
                {% for company_id, budget_data in analysis.summary.budget_utilization.items() %}
                <div class="budget-item">
                    <div class="budget-header">
                        <span class="company-name">{{ budget_data.company_name }}</span>
                        <span class="usage-percentage">{{ "{:.1f}".format(budget_data.usage_percentage) }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar {% if budget_data.usage_percentage > 75 %}progress-bar-danger{% elif budget_data.usage_percentage > 50 %}progress-bar-warning{% else %}progress-bar-success{% endif %}" 
                             style="width: {{ budget_data.usage_percentage }}%">
                        </div>
                    </div>
                    <div class="budget-details">
                        <span>Estimated: ₹{{ "{:,.0f}".format(budget_data.estimated_cost) }}</span>
                        <span>Budget: ₹{{ "{:,.0f}".format(budget_data.monthly_budget) }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Risk Assessment -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-shield-alt"></i>
                Risk Assessment
            </h3>
        </div>
        <div class="card-body">
            <div class="risk-matrix">
                <div class="risk-item high-risk">
                    <div class="risk-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="risk-content">
                        <div class="risk-title">High Risk Items</div>
                        <div class="risk-count">{{ analysis.summary.critical_items }}</div>
                        <div class="risk-description">Items with critical shortage levels</div>
                    </div>
                </div>
                
                <div class="risk-item medium-risk">
                    <div class="risk-icon"><i class="fas fa-clock"></i></div>
                    <div class="risk-content">
                        <div class="risk-title">Medium Risk Items</div>
                        <div class="risk-count">{{ analysis.summary.urgent_items }}</div>
                        <div class="risk-description">Items approaching shortage levels</div>
                    </div>
                </div>
                
                <div class="risk-item low-risk">
                    <div class="risk-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="risk-content">
                        <div class="risk-title">Low Risk Items</div>
                        <div class="risk-count">{{ analysis.summary.total_items - analysis.summary.critical_items - analysis.summary.urgent_items }}</div>
                        <div class="risk-description">Items with adequate stock levels</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-lightbulb"></i>
            AI Recommendations
        </h3>
    </div>
    <div class="card-body">
        <div class="recommendations-grid">
            {% if analysis.recommendations %}
                {% for recommendation in analysis.recommendations %}
                <div class="recommendation-item">
                    <div class="recommendation-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="recommendation-content">
                        <div class="recommendation-text">{{ recommendation }}</div>
                    </div>
                    <div class="recommendation-actions">
                        <button class="btn btn-sm btn-primary" onclick="implementRecommendation('{{ loop.index0 }}')">
                            <i class="fas fa-check"></i>
                            Implement
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-recommendations">
                    <i class="fas fa-check-circle"></i>
                    <p>No immediate recommendations. All inventory levels are optimal.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Procurement-specific JavaScript
function runFullAnalysis() {
    app.showLoading(true);
    fetch('/api/procurement/analyze', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ full_analysis: true })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast('Analysis completed successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            app.showToast('Analysis failed: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        app.showToast('Error running analysis', 'error');
        console.error('Analysis error:', error);
    })
    .finally(() => app.showLoading(false));
}

function autoGenerateOrders() {
    app.showLoading(true);
    fetch('/api/procurement/generate-orders', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast(`Generated ${data.orders_count} procurement orders`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            app.showToast('Failed to generate orders: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        app.showToast('Error generating orders', 'error');
        console.error('Order generation error:', error);
    })
    .finally(() => app.showLoading(false));
}

function contactVendor(itemId, companyId) {
    app.showLoading(true);
    fetch(`/api/procurement/contact-vendor`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, company_id: companyId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast('Vendor contacted successfully', 'success');
        } else {
            app.showToast('Failed to contact vendor', 'error');
        }
    })
    .catch(error => {
        app.showToast('Error contacting vendor', 'error');
    })
    .finally(() => app.showLoading(false));
}

function generateQuote(itemId, companyId) {
    app.showLoading(true);
    fetch(`/api/procurement/generate-quote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, company_id: companyId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast('Quote request sent successfully', 'success');
        } else {
            app.showToast('Failed to request quote', 'error');
        }
    })
    .catch(error => {
        app.showToast('Error requesting quote', 'error');
    })
    .finally(() => app.showLoading(false));
}

function markUrgent(itemId, companyId) {
    app.showLoading(true);
    fetch(`/api/procurement/mark-urgent`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_id: itemId, company_id: companyId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast('Item marked as urgent', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            app.showToast('Failed to mark as urgent', 'error');
        }
    })
    .catch(error => {
        app.showToast('Error marking item', 'error');
    })
    .finally(() => app.showLoading(false));
}

function implementRecommendation(index) {
    app.showLoading(true);
    fetch(`/api/procurement/implement-recommendation`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ recommendation_index: index })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast('Recommendation implemented', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            app.showToast('Failed to implement recommendation', 'error');
        }
    })
    .catch(error => {
        app.showToast('Error implementing recommendation', 'error');
    })
    .finally(() => app.showLoading(false));
}

// Auto-refresh data every 60 seconds
setInterval(() => {
    fetch('/api/procurement/analyze', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update stats without full page reload
            updateProcurementStats(data.analysis.summary);
        }
    })
    .catch(error => console.error('Auto-refresh error:', error));
}, 60000);

function updateProcurementStats(summary) {
    // Update dashboard stats in real-time
    const statsElements = {
        'critical_items': summary.critical_items,
        'urgent_items': summary.urgent_items,
        'companies_needing_procurement': summary.companies_needing_procurement,
        'total_estimated_cost': `₹${(summary.total_estimated_cost/1000).toFixed(0)}K`
    };
    
    Object.entries(statsElements).forEach(([key, value]) => {
        const element = document.querySelector(`[data-stat="${key}"] .stats-number`);
        if (element) {
            element.textContent = value;
        }
    });
}
</script>
{% endblock %} 