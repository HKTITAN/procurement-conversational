{% extends "dashboard.html" %}

{% block content %}
<!-- Companies Statistics -->
<div class="grid grid-4">
    <div class="stats-card">
        <div class="stats-icon">
            <i class="fas fa-building"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">{{ companies|length }}</div>
            <div class="stats-label">Total Companies</div>
        </div>
    </div>
    <div class="stats-card warning">
        <div class="stats-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">
                {% set critical_count = [] %}
                {% for company in companies %}
                    {% if company.status == 'critical' %}
                        {% set _ = critical_count.append(1) %}
                    {% endif %}
                {% endfor %}
                {{ critical_count|length }}
            </div>
            <div class="stats-label">Need Attention</div>
        </div>
    </div>
    <div class="stats-card success">
        <div class="stats-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">
                {% set total_budget = 0 %}
                {% for company in companies %}
                    {% set total_budget = total_budget + company.budget_monthly %}
                {% endfor %}
                ₹{{ "%.1f"|format(total_budget/1000000) }}M
            </div>
            <div class="stats-label">Total Budget</div>
        </div>
    </div>
    <div class="stats-card info">
        <div class="stats-icon">
            <i class="fas fa-percentage"></i>
        </div>
        <div class="stats-content">
            <div class="stats-number">
                {% set efficiency = 0 %}
                {% if companies %}
                    {% set good_companies = 0 %}
                    {% for company in companies %}
                        {% if company.status != 'critical' %}
                            {% set good_companies = good_companies + 1 %}
                        {% endif %}
                    {% endfor %}
                    {% set efficiency = (good_companies * 100 / companies|length)|int %}
                {% endif %}
                {{ efficiency }}%
            </div>
            <div class="stats-label">Efficiency</div>
        </div>
    </div>
</div>

<!-- Companies Management -->
<div class="card modern-card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-building"></i>
            Companies Management
        </h3>
        <div class="card-actions">
            <button class="btn btn-success" onclick="openAddCompanyModal()">
                <i class="fas fa-plus"></i>
                Add Company
            </button>
            <button class="btn btn-light" onclick="refreshCompanies()">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="companies-grid">
            {% for company in companies %}
            <div class="company-card" data-company="{{ company.company_id }}">
                <div class="company-header">
                    <div class="company-avatar">
                        {% if company.industry == 'Biotechnology' %}
                            <i class="fas fa-flask"></i>
                        {% elif company.industry == 'Pharmaceutical' %}
                            <i class="fas fa-pills"></i>
                        {% elif company.industry == 'Healthcare' %}
                            <i class="fas fa-heartbeat"></i>
                        {% else %}
                            <i class="fas fa-building"></i>
                        {% endif %}
                    </div>
                    <div class="company-title">
                        <h4>{{ company.name }}</h4>
                        <span class="industry-tag">{{ company.industry }}</span>
                    </div>
                    <div class="company-status status-{{ company.status }}">
                        {% if company.status == 'critical' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% elif company.status == 'warning' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% else %}
                            <i class="fas fa-check-circle"></i>
                        {% endif %}
                    </div>
                </div>
                
                <div class="company-details">
                    <div class="detail-row">
                        <i class="fas fa-user"></i>
                        <span>{{ company.contact_person }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-phone"></i>
                        <span>{{ company.phone }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-envelope"></i>
                        <span>{{ company.email }}</span>
                    </div>
                </div>
                
                <div class="company-metrics">
                    <div class="metric-item">
                        <div class="metric-label">Monthly Budget</div>
                        <div class="metric-value">₹{{ "{:,.0f}".format(company.budget_monthly) }}</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Priority</div>
                        <div class="priority-badge 
                            {% if company.procurement_priority == 'quality_first' %}quality
                            {% elif company.procurement_priority == 'cost_effective' %}cost
                            {% elif company.procurement_priority == 'urgent_delivery' %}urgent
                            {% else %}cost{% endif %}">
                            {{ company.procurement_priority.replace('_', ' ').title() }}
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Inventory Status</div>
                        <div class="inventory-status {{ company.status }}">
                            {% if company.low_stock_count > 0 %}
                                <span>{{ company.low_stock_count }} Low Stock</span>
                                {% set progress = ((company.total_items - company.low_stock_count) * 100 / company.total_items)|int if company.total_items > 0 else 0 %}
                            {% else %}
                                <span>All Good</span>
                                {% set progress = 100 %}
                            {% endif %}
                            <div class="progress-mini">
                                <div class="progress-fill {% if company.status == 'critical' %}danger{% endif %}" style="width: {{ progress }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="company-actions">
                    <button class="btn btn-primary btn-sm" onclick="viewCompany('{{ company.company_id }}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                    {% if company.status == 'critical' %}
                    <button class="btn btn-danger btn-sm" onclick="urgentCall('{{ company.company_id }}')">
                        <i class="fas fa-phone"></i>
                        Urgent Call
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-sm" onclick="callCompany('{{ company.company_id }}')">
                        <i class="fas fa-phone"></i>
                        Call
                    </button>
                    {% endif %}
                    <button class="btn btn-warning btn-sm" onclick="analyzeCompany('{{ company.company_id }}')">
                        <i class="fas fa-chart-bar"></i>
                        Analyze
                    </button>
                </div>
            </div>
            {% endfor %}
            
            {% if not companies %}
            <div class="company-card" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <div style="color: var(--gray-600);">
                    <i class="fas fa-building" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <h3>No Companies Found</h3>
                    <p>Add your first company to get started with procurement management.</p>
                    <button class="btn btn-success" onclick="openAddCompanyModal()">
                        <i class="fas fa-plus"></i>
                        Add First Company
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Analytics Overview -->
<div class="grid grid-2">
    <!-- Performance Chart -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                Performance Overview
            </h3>
        </div>
        <div class="card-body">
            <canvas id="performance-chart" width="400" height="250"></canvas>
        </div>
    </div>
    
    <!-- Budget Utilization -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie"></i>
                Budget Distribution
            </h3>
        </div>
        <div class="card-body">
            <div class="budget-breakdown">
                {% for company in companies %}
                <div class="budget-item">
                    <div class="budget-company">{{ company.name }}</div>
                    <div class="budget-bar">
                        {% set total_budget = 0 %}
                        {% for c in companies %}
                            {% set total_budget = total_budget + c.budget_monthly %}
                        {% endfor %}
                        {% set percentage = (company.budget_monthly * 100 / total_budget)|int if total_budget > 0 else 0 %}
                        <div class="budget-fill" style="width: {{ percentage }}%"></div>
                    </div>
                    <div class="budget-value">₹{{ "%.1f"|format(company.budget_monthly/100000) }}L ({{ percentage }}%)</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Companies management functions
function openAddCompanyModal() {
    app.showToast('Add company functionality coming soon', 'info');
}

function refreshCompanies() {
    app.showLoading(true);
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function viewCompany(companyId) {
    app.showToast(`Viewing ${companyId} details`, 'info');
}

function callCompany(companyId) {
    app.openModal('call-modal');
    // Pre-fill company data
}

function urgentCall(companyId) {
    app.showToast(`Initiating urgent call for ${companyId}`, 'warning');
    app.openModal('call-modal');
}

function analyzeCompany(companyId) {
    app.showLoading(true);
    fetch('/api/procurement/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ company_id: companyId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            app.showToast('Analysis completed', 'success');
            window.location.href = '/procurement';
        } else {
            app.showToast('Analysis failed', 'error');
        }
    })
    .catch(error => {
        app.showToast('Error during analysis', 'error');
    })
    .finally(() => app.showLoading(false));
}

// Initialize charts with real data
document.addEventListener('DOMContentLoaded', function() {
    // Performance Chart
    const performanceCtx = document.getElementById('performance-chart');
    if (performanceCtx) {
        const companies = {{ companies|tojson }};
        const companyNames = companies.map(c => c.name);
        const efficiencyData = companies.map(c => {
            if (c.total_items === 0) return 100;
            return Math.round(((c.total_items - c.low_stock_count) / c.total_items) * 100);
        });
        
        new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: companies.map((company, index) => ({
                    label: company.name,
                    data: Array(6).fill(0).map(() => Math.max(60, efficiencyData[index] + Math.random() * 20 - 10)),
                    borderColor: ['#6366f1', '#10b981', '#ef4444', '#f59e0b'][index % 4],
                    backgroundColor: `rgba(${index === 0 ? '99, 102, 241' : index === 1 ? '16, 185, 129' : index === 2 ? '239, 68, 68' : '245, 158, 11'}, 0.1)`,
                    tension: 0.4
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
});

// Add hover effects to company cards
document.querySelectorAll('.company-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-8px) scale(1.02)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) scale(1)';
    });
});

// Real-time updates
setInterval(() => {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // Update stats if needed
            console.log('Stats updated:', data);
        })
        .catch(error => console.log('Stats update failed:', error));
}, 30000);
</script>
{% endblock %} 